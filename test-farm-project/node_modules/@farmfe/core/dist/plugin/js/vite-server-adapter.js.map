{"version":3,"file":"vite-server-adapter.js","sourceRoot":"","sources":["../../../src/plugin/js/vite-server-adapter.ts"],"names":[],"mappings":"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","sourcesContent":["// import { watch } from 'chokidar';\nimport { FSWatcher } from 'chokidar';\nimport { Server } from '../../index.js';\nimport { Server as httpServer } from '../../server/type.js';\nimport WsServer from '../../server/ws.js';\nimport { CompilationContext, ViteModule } from '../type.js';\nimport { throwIncompatibleError } from './utils.js';\n\nexport class ViteDevServerAdapter {\n  moduleGraph: ViteModuleGraphAdapter;\n  config: any;\n  pluginName: string;\n  watcher: FSWatcher;\n  middlewares: any;\n  middlewareCallbacks: any[];\n  ws: WsServer;\n  httpServer: httpServer;\n\n  constructor(pluginName: string, config: any, server: Server) {\n    this.moduleGraph = createViteModuleGraphAdapter(pluginName);\n    this.config = config;\n    this.pluginName = pluginName;\n    // watcher is not used in Farm vite plugin for now\n    // it's only for compatibility\n    // this.watcher = watch(config.root);\n    this.watcher = server.watcher.getInternalWatcher();\n    this.middlewareCallbacks = [];\n    this.middlewares = new Proxy(\n      {\n        use: (...args: any[]) => {\n          if (\n            args.length === 2 &&\n            typeof args[0] === 'string' &&\n            typeof args[1] === 'function'\n          ) {\n            this.middlewareCallbacks.push((req: any, res: any, next: any) => {\n              const [url, cb] = args;\n              if (req.url.startsWith(url)) {\n                cb(req, res, next);\n              }\n            });\n          } else if (args.length === 1 && typeof args[0] === 'function') {\n            this.middlewareCallbacks.push(args[0]);\n          }\n        }\n      },\n      {\n        get(target, key) {\n          if (key === 'use') {\n            return target[key as keyof typeof target];\n          }\n\n          throwIncompatibleError(\n            pluginName,\n            'viteDevServer.middlewares',\n            ['use'],\n            key\n          );\n        }\n      }\n    );\n\n    this.ws = server.ws;\n    this.httpServer = server.server;\n  }\n}\n\nexport class ViteModuleGraphAdapter {\n  context: CompilationContext;\n  pluginName: string;\n\n  constructor(pluginName: string) {\n    // context will be set in buildStart hook\n    this.context = undefined;\n    this.pluginName = pluginName;\n  }\n\n  getModulesByFile(file: string): ViteModule[] {\n    const raw = this.context.viteGetModulesByFile(file);\n\n    return raw.map((item) => {\n      return proxyViteModuleNode(item, this.pluginName, this.context);\n    });\n  }\n\n  getModuleById(id: string): ViteModule {\n    const raw = this.context.viteGetModuleById(id);\n\n    if (raw) {\n      return proxyViteModuleNode(raw, this.pluginName, this.context);\n    }\n  }\n\n  async getModuleByUrl(url: string): Promise<ViteModule | undefined> {\n    if (url.startsWith('/')) {\n      url = url.slice(1);\n      const raw = this.context.viteGetModuleById(url);\n\n      if (raw) {\n        return proxyViteModuleNode(raw, this.pluginName, this.context);\n      }\n    }\n  }\n\n  invalidateModule() {\n    /** does thing for now, only for compatibility */\n  }\n}\n\nfunction proxyViteModuleNode(\n  node: ViteModule,\n  pluginName: string,\n  context: CompilationContext\n) {\n  const proxy = new Proxy(node, {\n    get(target, key) {\n      if (key === 'importers') {\n        return context.viteGetImporters(target.id);\n      }\n\n      const allowedKeys = ['url', 'id', 'file', 'type'];\n\n      if (allowedKeys.includes(String(key))) {\n        return target[key as keyof typeof target];\n      }\n\n      throwIncompatibleError(pluginName, 'viteModuleNode', allowedKeys, key);\n    }\n  });\n\n  return proxy;\n}\n\nexport function createViteDevServerAdapter(\n  pluginName: string,\n  config: any,\n  server: Server\n) {\n  const proxy = new Proxy(\n    new ViteDevServerAdapter(pluginName, config, server),\n    {\n      get(target, key) {\n        const objectKeys = [\n          'constructor',\n          'Symbol(Symbol.toStringTag)',\n          'prototype'\n        ];\n        const allowedKeys = [\n          'moduleGraph',\n          'config',\n          'watcher',\n          'middlewares',\n          'middlewareCallbacks',\n          'ws',\n          'httpServer'\n        ];\n        if (\n          objectKeys.includes(String(key)) ||\n          allowedKeys.includes(String(key))\n        ) {\n          return target[key as keyof typeof target];\n        }\n\n        throwIncompatibleError(pluginName, 'viteDevServer', allowedKeys, key);\n      }\n    }\n  );\n\n  return proxy;\n}\n\nexport function createViteModuleGraphAdapter(pluginName: string) {\n  const proxy = new Proxy(new ViteModuleGraphAdapter(pluginName), {\n    get(target, key) {\n      const allowedKeys = [\n        'getModulesByFile',\n        'getModuleById',\n        'getModuleByUrl',\n        'invalidateModule'\n      ];\n      const ownkeys = Reflect.ownKeys(target);\n\n      if (allowedKeys.includes(String(key)) || ownkeys.includes(key)) {\n        return target[key as keyof typeof target];\n      }\n\n      throwIncompatibleError(pluginName, 'viteModuleGraph', allowedKeys, key);\n    },\n    set(target, p, newValue, _receiver) {\n      if (p === 'context') {\n        target.context = newValue;\n        return true;\n      }\n\n      throwIncompatibleError(pluginName, 'viteModuleGraph', ['context'], p);\n    }\n  });\n\n  return proxy;\n}\n"]}