{"version":3,"file":"farm-to-vite-context.js","sourceRoot":"","sources":["../../../src/plugin/js/farm-to-vite-context.ts"],"names":[],"mappings":"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","sourcesContent":["import type { PluginContext } from 'rollup';\nimport type { UserConfig } from '../../config/types.js';\nimport { Logger } from '../../utils/logger.js';\nimport type { CompilationContext } from '../type.js';\nimport { normalizePath, revertNormalizePath } from './utils.js';\n\nconst contextCache = new Map<string, PluginContext>();\n\nexport function farmContextToViteContext(\n  farmContext: CompilationContext,\n  currentHandlingFile?: string,\n  pluginName?: string,\n  hookName?: string,\n  config?: UserConfig,\n  hookContext?: { caller?: string; meta: Record<string, unknown> }\n): PluginContext {\n  const cacheKey = pluginName + hookName + currentHandlingFile;\n  if (contextCache.has(cacheKey)) {\n    return contextCache.get(cacheKey) as PluginContext;\n  }\n  const logger = new Logger();\n\n  const log = (message: any) => {\n    if (typeof message === 'function') {\n      message = message();\n    }\n\n    console.log(message);\n  };\n\n  const cacheError = () => {\n    throw new Error(\n      `Vite plugin ${pluginName} is not compatible with Farm for now. Because cache(called by hook ${pluginName}.${hookName}) is not supported in Farm`\n    );\n  };\n\n  const viteContext: PluginContext = {\n    addWatchFile: (id) => {\n      if (!currentHandlingFile) {\n        throw new Error(\n          `Vite plugin ${pluginName} is not compatible with Farm for now. Because addWatchFile(called by hook ${pluginName}.${hookName}) can only be called in load hook or transform hook in Farm.`\n        );\n      }\n      farmContext.addWatchFile(currentHandlingFile, id);\n    },\n    debug: log,\n    emitFile: (params) => {\n      if (params.type === 'asset') {\n        let content: number[] = [];\n\n        if (typeof params.source === 'string') {\n          content = [...Buffer.from(params.source)];\n        } else {\n          content = [...params.source];\n        }\n\n        farmContext.emitFile({\n          resolvedPath: currentHandlingFile ?? 'vite-plugin-adapter',\n          name: params.fileName ?? params.name,\n          content,\n          resourceType: 'asset'\n        });\n\n        return 'vite-plugin-adapter-unsupported-reference-id';\n      } else {\n        throw new Error(\n          `Vite plugin ${pluginName} is not compatible with Farm for now. Because emitFile(called by hook ${pluginName}.${hookName}) can only emit asset in Farm.`\n        );\n      }\n    },\n    error: (message): never => {\n      let msgObj = message as any;\n      if (typeof msgObj !== 'object') {\n        msgObj = {\n          message: message as string\n        };\n      }\n\n      if (msgObj.code && !msgObj.code.startsWith('PLUGIN_')) {\n        msgObj.pluginCode = 'PLUGIN_ERROR';\n      } else {\n        msgObj.code = 'PLUGIN_ERROR';\n      }\n\n      msgObj.plugin = pluginName;\n      msgObj.id = currentHandlingFile;\n      msgObj.hook = hookName;\n\n      farmContext.error(JSON.stringify(msgObj));\n\n      return undefined as unknown as never;\n    },\n    getFileName: () => {\n      throw new Error(\n        `Vite plugin ${pluginName} is not compatible with Farm for now. Because getFileName(called by hook ${pluginName}.${hookName}) is not supported in Farm`\n      );\n    },\n    getModuleIds: () => {\n      throw new Error(\n        `Vite plugin ${pluginName} is not compatible with Farm for now. Because getModuleIds(called by hook ${pluginName}.${hookName}) is not supported in Farm`\n      );\n    },\n    getModuleInfo: () => {\n      throw new Error(\n        `Vite plugin ${pluginName} is not compatible with Farm for now. Because getModuleInfo(called by hook ${pluginName}.${hookName}) is not supported in Farm`\n      );\n    },\n    getWatchFiles: () => {\n      return farmContext.getWatchFiles();\n    },\n    info: log,\n    load: (_) => {\n      throw new Error(\n        `Vite plugin ${pluginName} is not compatible with Farm for now. Because load(called by hook ${pluginName}.${hookName}) is not supported in Farm`\n      );\n    },\n    meta: {\n      rollupVersion: '3.29.4',\n      watchMode: config.compilation?.mode !== 'production'\n    },\n    parse: (_) => {\n      throw new Error(\n        `Vite plugin ${pluginName} is not compatible with Farm for now. Because parse(called by hook ${pluginName}.${hookName}) is not supported in Farm`\n      );\n    },\n    resolve: async (source, importer, options = {}) => {\n      if (options.custom?.caller === `${pluginName}.${hookName}`) {\n        return null;\n      }\n\n      // if importer is a windows style absolute path, replace all / with \\\\ to make it a valid windows path\n      if (/^[a-zA-Z]:\\//.test(importer)) {\n        importer = revertNormalizePath(importer);\n      }\n\n      const farmResolveResult = await farmContext.resolve(\n        {\n          source,\n          importer,\n          kind: options.isEntry ? 'entry' : 'import'\n        },\n        {\n          meta: hookContext?.meta ?? {},\n          caller: `${pluginName}.${hookName}`\n        }\n      );\n\n      if (farmResolveResult) {\n        return {\n          id: normalizePath(farmResolveResult.resolvedPath),\n          external: farmResolveResult.external,\n          resolvedBy: 'vite-plugin-adapter-farm-resolve',\n          moduleSideEffects: farmResolveResult.sideEffects,\n          meta: {\n            ...farmResolveResult.meta,\n            caller: `${pluginName}.${hookName}`\n          },\n          // TODO these 2 options are not supported in farm\n          assertions: {},\n          syntheticNamedExports: false\n        };\n      }\n\n      return null;\n    },\n    setAssetSource(assetReferenceId, source) {\n      this.emitFile({\n        type: 'asset',\n        source,\n        name: assetReferenceId\n      });\n    },\n    warn: (message) => {\n      if (typeof message === 'object') {\n        farmContext.warn(JSON.stringify(message));\n      } else if (typeof message === 'function') {\n        farmContext.warn(JSON.stringify(message()));\n      } else {\n        farmContext.warn(message);\n      }\n    },\n    cache: {\n      set: cacheError,\n      get: cacheError,\n      delete: cacheError,\n      has: cacheError\n    },\n    moduleIds: new Set<string>()[Symbol.iterator](),\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore Vite specific property\n    getCombinedSourcemap() {\n      logger.warn(\n        '`vite-plugin-adapter`: getCombinedSourcemap is not supported in Farm for now. It will always return undefined.'\n      );\n      return undefined;\n    }\n  };\n\n  contextCache.set(cacheKey, viteContext);\n\n  return viteContext;\n}\n"]}