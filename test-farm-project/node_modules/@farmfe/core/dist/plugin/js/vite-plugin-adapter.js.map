{"version":3,"file":"vite-plugin-adapter.js","sourceRoot":"","sources":["../../../src/plugin/js/vite-plugin-adapter.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ResolvedUserConfig, UserConfig } from '../../config/types.js';\nimport type { Server } from '../../server/index.js';\nimport {\n  CompilationContext,\n  CompilationContextEmitFileParams,\n  JsPlugin,\n  PluginFinalizeResourcesHookParams,\n  PluginRenderResourcePotParams,\n  Resource,\n  ResourcePotInfo\n} from '../type.js';\nimport {\n  FARM_CSS_MODULES_SUFFIX,\n  VITE_PLUGIN_DEFAULT_MODULE_TYPE,\n  convertEnforceToPriority,\n  customParseQueryString,\n  decodeStr,\n  encodeStr,\n  formatId,\n  formatLoadModuleType,\n  formatTransformModuleType,\n  getContentValue,\n  isObject,\n  isStartsWithSlash,\n  isString,\n  normalizeAdapterVirtualModule,\n  normalizePath,\n  removeQuery,\n  revertNormalizePath,\n  transformFarmConfigToRollupNormalizedOutputOptions,\n  transformResourceInfo2RollupRenderedChunk,\n  transformRollupResource2FarmResource\n} from './utils.js';\n\n// only use types from vite and we do not install vite as a dependency\nimport type {\n  ConfigEnv,\n  HmrContext,\n  ModuleNode,\n  Plugin,\n  ViteDevServer,\n  UserConfig as ViteUserConfig\n} from 'vite';\n\nimport path from 'path';\nimport fse from 'fs-extra';\nimport { readFile } from 'fs/promises';\nimport type {\n  FunctionPluginHooks,\n  OutputBundle,\n  RenderChunkHook,\n  ResolveIdResult\n} from 'rollup';\nimport { VIRTUAL_FARM_DYNAMIC_IMPORT_SUFFIX } from '../../compiler/index.js';\nimport { CompilationMode } from '../../config/env.js';\nimport { Logger } from '../../index.js';\nimport {\n  Config,\n  PluginLoadHookParam,\n  PluginLoadHookResult,\n  PluginResolveHookParam,\n  PluginResolveHookResult,\n  PluginTransformHookParam,\n  PluginTransformHookResult\n} from '../../types/binding.js';\nimport merge from '../../utils/merge.js';\nimport { applyHtmlTransform } from './apply-html-transform.js';\nimport {\n  farmUserConfigToViteConfig,\n  proxyViteConfig,\n  viteConfigToFarmConfig\n} from './farm-to-vite-config.js';\nimport { farmContextToViteContext } from './farm-to-vite-context.js';\nimport {\n  transformFarmConfigToRollupNormalizedInputOptions,\n  transformResourceInfo2RollupResource\n} from './utils.js';\nimport {\n  ViteDevServerAdapter,\n  ViteModuleGraphAdapter,\n  createViteDevServerAdapter\n} from './vite-server-adapter.js';\n\ntype OmitThis<T extends (this: any, ...args: any[]) => any> = T extends (\n  this: any,\n  ...args: infer A\n) => infer R\n  ? (...arg: A) => R\n  : T;\ntype ObjectHook<T, O = Record<string, any>> =\n  | T\n  | ({ handler: T; order?: 'pre' | 'post' | null } & O);\n\n/// turn a vite plugin to farm js plugin\nexport class VitePluginAdapter implements JsPlugin {\n  name = 'to-be-override';\n  priority = 0;\n\n  private _rawPlugin: Plugin;\n  private _farmConfig: UserConfig;\n  private _viteConfig: ViteUserConfig;\n  private _viteDevServer: ViteDevServerAdapter;\n  private _logger: Logger;\n  private _moduleGraph: ViteModuleGraphAdapter;\n\n  buildStart: JsPlugin['buildStart'];\n  resolve: JsPlugin['resolve'];\n  load: JsPlugin['load'];\n  transform: JsPlugin['transform'];\n  buildEnd: JsPlugin['buildEnd'];\n  finish: JsPlugin['finish'];\n  updateModules: JsPlugin['updateModules'];\n  renderResourcePot: JsPlugin['renderResourcePot'];\n  renderStart: JsPlugin['renderStart'];\n  augmentResourceHash?: JsPlugin['augmentResourceHash'];\n  finalizeResources: JsPlugin['finalizeResources'];\n  writeResources: JsPlugin['writeResources'];\n  transformHtml: JsPlugin['transformHtml'];\n\n  // filter for js plugin to improve performance\n  filters: string[];\n\n  constructor(\n    rawPlugin: Plugin,\n    farmConfig: UserConfig,\n    filters: string[],\n    logger: Logger,\n    mode: CompilationMode\n  ) {\n    this.name = rawPlugin.name || `vite-plugin-adapted-${Date.now()}`;\n    if (!rawPlugin.name) {\n      throw new Error(\n        `Vite plugin ${rawPlugin} is not compatible with Farm for now. Because plugin name is required in Farm.`\n      );\n    }\n\n    this.priority = convertEnforceToPriority(rawPlugin.enforce);\n    this._rawPlugin = rawPlugin;\n    this._farmConfig = farmConfig;\n    this._viteConfig = farmUserConfigToViteConfig(farmConfig);\n    this._logger = logger;\n\n    this.filters = filters;\n\n    const hooksMap = {\n      buildStart: () =>\n        (this.buildStart = this.viteBuildStartToFarmBuildStart()),\n      resolveId: () => (this.resolve = this.viteResolveIdToFarmResolve()),\n      load: () => (this.load = this.viteLoadToFarmLoad()),\n      transform: () => (this.transform = this.viteTransformToFarmTransform()),\n      buildEnd: () => (this.buildEnd = this.viteBuildEndToFarmBuildEnd()),\n      // closeBundle: () => (this.finish = this.viteCloseBundleToFarmFinish()),\n      handleHotUpdate: () =>\n        (this.updateModules = this.viteHandleHotUpdateToFarmUpdateModules()),\n      renderChunk: () =>\n        (this.renderResourcePot =\n          this.viteHandleRenderChunkToFarmRenderResourcePot()),\n      renderStart: () =>\n        (this.renderStart = this.viteRenderStartToFarmRenderStart()),\n      augmentChunkHash: () =>\n        (this.augmentResourceHash =\n          this.viteAugmentChunkHashToFarmAugmentResourceHash()),\n      generateBundle: () =>\n        (this.finalizeResources =\n          this.viteGenerateBundleToFarmFinalizeResources()),\n      transformIndexHtml: () =>\n        (this.transformHtml = this.viteTransformIndexHtmlToFarmTransformHtml()),\n      'writeBundle|closeBundle': () =>\n        (this.writeResources = this.viteWriteCloseBundleToFarmWriteResources())\n    };\n    const alwaysExecutedHooks = ['buildStart'];\n    const productionOnlyHooks = [\n      'renderChunk',\n      'generateBundle',\n      'renderStart',\n      'closeBundle',\n      'writeBundle'\n    ];\n\n    // convert hooks\n    for (const [hookNameGroup, fn] of Object.entries(hooksMap)) {\n      const hookNames = hookNameGroup.split('|');\n\n      for (const hookName of hookNames) {\n        if (\n          rawPlugin[hookName as keyof Plugin] ||\n          alwaysExecutedHooks.includes(hookName)\n        ) {\n          if (mode !== 'production' && productionOnlyHooks.includes(hookName)) {\n            continue;\n          }\n\n          fn();\n        }\n      }\n    }\n\n    // if other unsupported vite plugins hooks are used, throw error\n    const unsupportedHooks = [\n      'moduleParsed',\n      'renderError',\n      'resolveDynamicImport',\n      'resolveFileUrl',\n      'resolveImportMeta',\n      'shouldTransformCachedModule',\n      'banner',\n      'footer'\n    ];\n\n    for (const hookName of unsupportedHooks) {\n      if (this._rawPlugin[hookName as keyof Plugin]) {\n        throw new Error(\n          `Vite plugin ${this.name} is not compatible with Farm for now. Because it uses hook \"${hookName}\" which is not supported by Farm.`\n        );\n      }\n    }\n  }\n\n  get api() {\n    return this._rawPlugin.api;\n  }\n\n  // call both config and configResolved\n  async config(config: UserConfig) {\n    this._farmConfig = config;\n    this._viteConfig = farmUserConfigToViteConfig(this._farmConfig);\n\n    const configHook = this.wrapRawPluginHook('config', this._rawPlugin.config);\n\n    if (configHook) {\n      this._viteConfig = proxyViteConfig(\n        merge(\n          this._viteConfig,\n          await configHook(\n            proxyViteConfig(this._viteConfig, this.name, this._logger),\n            this.getViteConfigEnv()\n          )\n        ),\n        this.name,\n        this._logger\n      );\n\n      this._farmConfig = viteConfigToFarmConfig(\n        this._viteConfig,\n        this._farmConfig,\n        this.name\n      );\n    }\n\n    return this._farmConfig;\n  }\n\n  async configResolved(config: ResolvedUserConfig) {\n    this._farmConfig = config;\n    this._viteConfig = proxyViteConfig(\n      farmUserConfigToViteConfig(config),\n      this.name,\n      this._logger\n    );\n\n    if (!this._rawPlugin.configResolved) return;\n\n    const configResolvedHook = this.wrapRawPluginHook(\n      'configResolved',\n      this._rawPlugin.configResolved\n    );\n\n    if (configResolvedHook) {\n      await configResolvedHook(this._viteConfig);\n    }\n  }\n\n  async configureDevServer(devServer: Server) {\n    const hook = this.wrapRawPluginHook(\n      'configureServer',\n      this._rawPlugin.configureServer\n    );\n\n    this._viteDevServer = createViteDevServerAdapter(\n      this.name,\n      this._viteConfig,\n      devServer\n    );\n\n    if (hook) {\n      await hook(this._viteDevServer);\n      this._viteDevServer.middlewareCallbacks.forEach((cb) => {\n        devServer.app().use((ctx, koaNext) => {\n          return new Promise((resolve, reject) => {\n            // koaNext is async, but vite's next is sync, we need a adapter here\n            const next = (err: Error) => {\n              if (err) reject(err);\n              koaNext().then(resolve);\n            };\n\n            return cb(ctx.req, ctx.res, next);\n          });\n        });\n      });\n    }\n  }\n\n  private getViteConfigEnv(): ConfigEnv {\n    return {\n      isSsrBuild: this._farmConfig.compilation?.output?.targetEnv === 'node',\n      command:\n        this._farmConfig.compilation?.mode === 'production' ? 'build' : 'serve',\n      mode: this._farmConfig.compilation?.mode\n    };\n  }\n\n  private shouldExecutePlugin() {\n    const command =\n      this._farmConfig.compilation?.mode === 'production' ? 'build' : 'serve';\n\n    if (typeof this._rawPlugin.apply === 'function') {\n      return this._rawPlugin.apply(this._viteConfig, {\n        mode: this._farmConfig.compilation.mode,\n        command,\n        isSsrBuild: this._farmConfig.compilation.output?.targetEnv === 'node'\n      });\n    } else if (this._rawPlugin.apply === undefined) {\n      return true;\n    }\n\n    return this._rawPlugin.apply === command;\n  }\n\n  private wrapExecutor(executor: (...args: any[]) => any) {\n    return async (...args: any[]) => {\n      if (this.shouldExecutePlugin()) {\n        return await executor(...args);\n      }\n    };\n  }\n\n  private wrapRawPluginHook(\n    hookName: string,\n    hook?: ObjectHook<(...args: any[]) => any, { sequential?: boolean }>,\n    farmContext?: CompilationContext,\n    currentHandlingFile?: string,\n    hookContext?: { caller?: string; meta: Record<string, unknown> }\n  ): (\n    ...args: any[]\n  ) => any | undefined | Promise<(...args: any[]) => any | undefined> {\n    if (hook === undefined) {\n      return undefined;\n    }\n\n    if (typeof hook === 'object') {\n      if (!hook.handler) {\n        return undefined;\n      }\n\n      const logWarn = (name: string) => {\n        this._logger.warn(\n          `Farm does not support '${name}' property of vite plugin ${this.name} hook ${hookName} for now. '${name}' property will be ignored.`\n        );\n      };\n      const supportedHooks = ['transformIndexHtml'];\n      // TODO support order, if a hook has order, it should be split into two plugins\n      if (hook.order && !supportedHooks.includes(hookName)) {\n        logWarn('order');\n      }\n      if (hook.sequential) {\n        logWarn('sequential');\n      }\n\n      hook = hook.handler;\n    }\n\n    if (farmContext) {\n      const pluginContext = farmContextToViteContext(\n        farmContext,\n        currentHandlingFile,\n        this.name,\n        hookName,\n        this._farmConfig,\n        hookContext\n      );\n      return hook.bind(pluginContext);\n    } else {\n      return hook;\n    }\n  }\n\n  private viteBuildStartToFarmBuildStart(): JsPlugin['buildStart'] {\n    return {\n      executor: this.wrapExecutor((_, context) => {\n        const hook = this.wrapRawPluginHook(\n          'buildStart',\n          this._rawPlugin.buildStart,\n          context\n        );\n        if (this._viteDevServer) {\n          this._viteDevServer.moduleGraph.context = context;\n        }\n        return hook?.();\n      })\n    };\n  }\n\n  private viteResolveIdToFarmResolve(): JsPlugin['resolve'] {\n    return {\n      filters: { sources: ['.*'], importers: this.filters },\n      executor: this.wrapExecutor(\n        async (\n          params: PluginResolveHookParam,\n          context: CompilationContext,\n          hookContext?: { caller?: string; meta: Record<string, unknown> }\n        ): Promise<PluginResolveHookResult> => {\n          if (\n            VitePluginAdapter.isFarmInternalVirtualModule(params.source) ||\n            (params.importer &&\n              VitePluginAdapter.isFarmInternalVirtualModule(params.importer)) ||\n            hookContext?.caller === this.name + '.resolveId'\n          ) {\n            return null;\n          }\n\n          const hook = this.wrapRawPluginHook(\n            'resolveId',\n            this._rawPlugin.resolveId,\n            context,\n            undefined,\n            hookContext\n          );\n          const absImporterPath = normalizePath(\n            path.resolve(process.cwd(), params.importer ?? '')\n          );\n          let resolveIdResult: ResolveIdResult = await hook?.(\n            decodeStr(params.source),\n            absImporterPath,\n            { isEntry: params.kind === 'entry' }\n          );\n\n          if (isString(resolveIdResult)) {\n            resolveIdResult = normalizeAdapterVirtualModule(resolveIdResult);\n            return {\n              resolvedPath: removeQuery(encodeStr(resolveIdResult)),\n              query: customParseQueryString(resolveIdResult),\n              sideEffects: true,\n              external: false,\n              meta: {}\n            };\n          } else if (isObject(resolveIdResult)) {\n            const resolveId = normalizeAdapterVirtualModule(\n              resolveIdResult?.id\n            );\n            return {\n              resolvedPath: removeQuery(encodeStr(resolveId)),\n              query: customParseQueryString(resolveId),\n              sideEffects: Boolean(resolveIdResult?.moduleSideEffects),\n              // TODO support relative and absolute external\n              external: Boolean(resolveIdResult?.external),\n              meta: resolveIdResult.meta ?? {}\n            };\n          }\n\n          // handles paths starting with / in the vite plugin,\n          // returning the correct path if the file exists in our root path\n          const rootAbsolutePath = path.join(\n            this._farmConfig.root,\n            params.source\n          );\n\n          if (\n            isStartsWithSlash(params.source) &&\n            fse.pathExistsSync(rootAbsolutePath)\n          ) {\n            return {\n              resolvedPath: removeQuery(encodeStr(rootAbsolutePath)),\n              query: customParseQueryString(rootAbsolutePath),\n              sideEffects: false,\n              external: false,\n              meta: {}\n            };\n          }\n\n          return null;\n        }\n      )\n    };\n  }\n\n  private viteLoadToFarmLoad(): JsPlugin['load'] {\n    return {\n      filters: {\n        resolvedPaths: this.filters\n      },\n      executor: this.wrapExecutor(\n        async (\n          params: PluginLoadHookParam,\n          context: CompilationContext\n        ): Promise<PluginLoadHookResult> => {\n          if (VitePluginAdapter.isFarmInternalVirtualModule(params.moduleId)) {\n            return null;\n          }\n          const hook = this.wrapRawPluginHook(\n            'load',\n            this._rawPlugin.load,\n            context,\n            params.moduleId\n          );\n\n          const isSSR =\n            this._farmConfig.compilation.output?.targetEnv === 'node';\n          const resolvedPath = normalizePath(decodeStr(params.resolvedPath));\n\n          // append query\n          const id = formatId(resolvedPath, params.query);\n          const result = await hook?.(id, isSSR ? { ssr: true } : undefined);\n\n          if (result) {\n            let map = undefined;\n\n            if (typeof result === 'object' && result.map) {\n              if (typeof result.map === 'string') {\n                map = result.map;\n              } else if (typeof result.map === 'object') {\n                map = JSON.stringify(result.map);\n              }\n            }\n\n            return {\n              content: getContentValue(result),\n              // only support css as first class citizen for vite plugins\n              moduleType: formatLoadModuleType(id),\n              sourceMap: map\n              // does not support meta and sideEffects\n            };\n          }\n        }\n      )\n    };\n  }\n\n  private viteTransformToFarmTransform(): JsPlugin['transform'] {\n    // default module type and asset can be transformed by vite transform hook\n    const moduleTypesCouldTransform = [\n      VITE_PLUGIN_DEFAULT_MODULE_TYPE,\n      'asset',\n      'json'\n    ];\n    return {\n      filters: {\n        resolvedPaths: this.filters\n      },\n      executor: this.wrapExecutor(\n        async (\n          params: PluginTransformHookParam,\n          context: CompilationContext\n        ): Promise<PluginTransformHookResult> => {\n          if (VitePluginAdapter.isFarmInternalVirtualModule(params.moduleId)) {\n            return null;\n          }\n\n          const hook = this.wrapRawPluginHook(\n            'transform',\n            this._rawPlugin.transform,\n            context,\n            params.moduleId\n          );\n          const isSSR =\n            this._farmConfig.compilation.output?.targetEnv === 'node';\n          const resolvedPath = normalizePath(decodeStr(params.resolvedPath));\n          // append query\n          const id = formatId(resolvedPath, params.query);\n\n          const result = await hook?.(\n            params.content,\n            id,\n            isSSR ? { ssr: true } : undefined\n          );\n\n          if (result) {\n            const content = getContentValue(result);\n            // fix #1180, do not transform empty content\n            if (content) {\n              return {\n                content,\n                sourceMap:\n                  typeof result.map === 'object' && result.map !== null\n                    ? JSON.stringify(result.map)\n                    : undefined,\n                moduleType: moduleTypesCouldTransform.includes(\n                  params.moduleType\n                )\n                  ? formatTransformModuleType(id)\n                  : params.moduleType\n                // TODO support meta and sideEffects\n              };\n            }\n          }\n        }\n      )\n    };\n  }\n\n  private viteBuildEndToFarmBuildEnd(): JsPlugin['buildEnd'] {\n    return {\n      executor: this.wrapExecutor((_, context) => {\n        const hook = this.wrapRawPluginHook(\n          'buildEnd',\n          this._rawPlugin.buildEnd,\n          context\n        );\n        return hook?.();\n      })\n    };\n  }\n\n  private viteHandleHotUpdateToFarmUpdateModules(): JsPlugin['updateModules'] {\n    return {\n      executor: this.wrapExecutor(\n        async ({ paths }: { paths: [string, string][] }, ctx) => {\n          const hook = this.wrapRawPluginHook(\n            'handleHotUpdate',\n            this._rawPlugin.handleHotUpdate,\n            ctx\n          );\n\n          let moduleGraph: ViteModuleGraphAdapter;\n\n          if (this._viteDevServer) {\n            moduleGraph = this._viteDevServer.moduleGraph;\n          } else if (this._moduleGraph) {\n            moduleGraph = this._moduleGraph;\n          } else {\n            moduleGraph = new ViteModuleGraphAdapter(this.name);\n            this._moduleGraph = moduleGraph;\n          }\n\n          moduleGraph.context = ctx;\n\n          const result = [];\n\n          for (const [file, _] of paths) {\n            const mods = moduleGraph.getModulesByFile(\n              file\n            ) as unknown as ModuleNode[];\n            const filename = normalizePath(file);\n            const ctx: HmrContext = {\n              file: filename,\n              timestamp: Date.now(),\n              modules: (mods ?? []).map(\n                (m) =>\n                  ({\n                    ...m,\n                    id: normalizePath(m.id),\n                    file: normalizePath(m.file)\n                  }) as ModuleNode\n              ),\n              read: function (): string | Promise<string> {\n                return readFile(file, 'utf-8');\n              },\n              server: this._viteDevServer as unknown as ViteDevServer\n            };\n            const updateMods: ModuleNode[] = await hook?.(ctx);\n\n            if (updateMods) {\n              result.push(...updateMods.map((mod) => mod.id));\n            } else {\n              result.push(...mods.map((mod) => mod.id));\n            }\n          }\n\n          return [...new Set(result)].map((id) => revertNormalizePath(id));\n        }\n      )\n    };\n  }\n\n  private viteHandleRenderChunkToFarmRenderResourcePot(): JsPlugin['renderResourcePot'] {\n    return {\n      filters: {\n        moduleIds: this.filters\n      },\n      executor: this.wrapExecutor(\n        async (param: PluginRenderResourcePotParams, ctx) => {\n          if (param.resourcePotInfo.resourcePotType !== 'js') {\n            return;\n          }\n\n          const hook = this.wrapRawPluginHook(\n            'renderChunk',\n            this._rawPlugin.renderChunk,\n            ctx\n          );\n\n          const result: ReturnType<RenderChunkHook> = await hook(\n            param.content,\n            transformResourceInfo2RollupRenderedChunk(param.resourcePotInfo),\n            {},\n            {\n              chunks: {}\n            }\n          );\n\n          if (result) {\n            if (typeof result === 'string') {\n              return { content: result };\n            } else if (typeof result === 'object') {\n              return { content: result.code, sourceMap: result.map };\n            }\n          }\n        }\n      )\n    };\n  }\n\n  private viteRenderStartToFarmRenderStart(): JsPlugin['renderStart'] {\n    return {\n      executor: this.wrapExecutor(async (param: Config['config'], ctx) => {\n        const hook = this.wrapRawPluginHook(\n          'renderStart',\n          this._rawPlugin.renderStart,\n          ctx\n        ) as OmitThis<FunctionPluginHooks['renderStart']>;\n\n        await hook(\n          transformFarmConfigToRollupNormalizedOutputOptions(param),\n          transformFarmConfigToRollupNormalizedInputOptions(param)\n        );\n      })\n    };\n  }\n\n  private viteAugmentChunkHashToFarmAugmentResourceHash(): JsPlugin['augmentResourceHash'] {\n    return {\n      filters: {\n        moduleIds: this.filters\n      },\n      executor: this.wrapExecutor(async (param: ResourcePotInfo, context) => {\n        if (param.resourcePotType !== 'js') {\n          return;\n        }\n\n        const hook = this.wrapRawPluginHook(\n          'augmentChunkHash',\n          this._rawPlugin.augmentChunkHash,\n          context\n        ) as OmitThis<FunctionPluginHooks['augmentChunkHash']>;\n\n        const hash = await hook?.(\n          transformResourceInfo2RollupRenderedChunk(param)\n        );\n\n        return hash;\n      })\n    };\n  }\n\n  private viteGenerateBundleToFarmFinalizeResources(): JsPlugin['finalizeResources'] {\n    return {\n      executor: this.wrapExecutor(\n        async (param: PluginFinalizeResourcesHookParams, context) => {\n          // Fix resourcesMap deadlock called by emitFile.\n          // Cause Farm called resourcesMap.lock() before calling this hook, and this.emitFile would call resourcesMap.lock()\n          // this leads to deadlock when calling emitFile in finalize_resources hook.\n          // so we hack context.emitFile here to avoid deadlock\n          const emittedFiles: CompilationContextEmitFileParams[] = [];\n          context.emitFile = async (\n            params: CompilationContextEmitFileParams\n          ) => {\n            emittedFiles.push(params);\n          };\n          const hook = this.wrapRawPluginHook(\n            'generateBundle',\n            this._rawPlugin.generateBundle,\n            context\n          );\n\n          const bundles = Object.entries(param.resourcesMap).reduce(\n            (res, [key, val]) => {\n              res[key] = transformResourceInfo2RollupResource(val);\n              return res;\n            },\n            {} as OutputBundle\n          );\n\n          await hook?.(\n            transformFarmConfigToRollupNormalizedOutputOptions(param.config),\n            bundles\n          );\n\n          const emittedFilesMap = emittedFiles.reduce(\n            (res, item) => {\n              res[item.name] = {\n                name: item.name,\n                bytes: item.content,\n                emitted: false,\n                resourceType: 'asset',\n                origin: {\n                  type: 'Module',\n                  value: 'vite-plugin-adapter-generate-bundle-hook'\n                }\n              };\n              return res;\n            },\n            {} as PluginFinalizeResourcesHookParams['resourcesMap']\n          );\n\n          const result = Object.entries(bundles).reduce((res, [key, val]) => {\n            res[key] = transformRollupResource2FarmResource(\n              val,\n              param.resourcesMap[key]\n            );\n            return res;\n          }, emittedFilesMap);\n\n          return result;\n        }\n      )\n    };\n  }\n\n  private viteTransformIndexHtmlToFarmTransformHtml(): JsPlugin['transformHtml'] {\n    const rawTransformHtmlHook: any = this._rawPlugin.transformIndexHtml;\n    const order: 'pre' | 'post' | 'normal' =\n      rawTransformHtmlHook?.order ??\n      rawTransformHtmlHook?.enforce ??\n      this._rawPlugin.enforce ??\n      'normal';\n\n    const orderMap: Record<string, 0 | 1 | 2> = {\n      pre: 0,\n      normal: 1,\n      post: 2\n    };\n\n    return {\n      order: orderMap[order] ?? 1,\n      executor: this.wrapExecutor(\n        async (params: { htmlResource: Resource }, context) => {\n          const { htmlResource } = params;\n          const hook = this.wrapRawPluginHook(\n            'transformIndexHtml',\n            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n            // @ts-ignore ignore type error\n            this._rawPlugin.transformIndexHtml,\n            context\n          );\n\n          const result = await this.callViteTransformIndexHtmlHook(\n            htmlResource,\n            hook\n          );\n\n          if (result) {\n            htmlResource.bytes = [...Buffer.from(result)];\n          }\n\n          return htmlResource;\n        }\n      )\n    };\n  }\n\n  private viteWriteCloseBundleToFarmWriteResources(): JsPlugin['writeResources'] {\n    return {\n      executor: this.wrapExecutor(\n        async (param: PluginFinalizeResourcesHookParams, context) => {\n          const hook = this.wrapRawPluginHook(\n            'writeBundle',\n            this._rawPlugin.writeBundle,\n            context\n          );\n\n          if (hook) {\n            const bundles = Object.entries(param.resourcesMap).reduce(\n              (res, [key, val]) => {\n                res[key] = transformResourceInfo2RollupResource(val);\n                return res;\n              },\n              {} as OutputBundle\n            );\n\n            await hook?.(\n              transformFarmConfigToRollupNormalizedOutputOptions(param.config),\n              bundles\n            );\n          }\n\n          const closeBundle = this.wrapRawPluginHook(\n            'closeBundle',\n            this._rawPlugin.closeBundle\n          );\n          return closeBundle?.();\n        }\n      )\n    };\n  }\n\n  private async callViteTransformIndexHtmlHook(\n    resource: Resource,\n    transformIndexHtmlHook?: (...args: any[]) => Promise<string>,\n    bundles?: OutputBundle\n  ) {\n    const html = Buffer.from(resource.bytes).toString();\n    const result = await transformIndexHtmlHook?.(html, {\n      path: resource.name,\n      filename: resource.name,\n      server: bundles === undefined ? this._viteDevServer : undefined,\n      bundle: bundles,\n      chunk: transformResourceInfo2RollupResource(resource)\n    });\n\n    if (result && typeof result !== 'string') {\n      return applyHtmlTransform(html, result);\n    } else if (typeof result === 'string') {\n      return result;\n    }\n  }\n\n  // skip farm lazy compilation virtual module for vite plugin\n  public static isFarmInternalVirtualModule(id: string) {\n    return (\n      id.endsWith(VIRTUAL_FARM_DYNAMIC_IMPORT_SUFFIX) ||\n      // css has been handled before the virtual module is created\n      FARM_CSS_MODULES_SUFFIX.test(id)\n    );\n  }\n}\n"]}